---
title: Java keyword volatile
date: 2023-07-22 17:28:00
categories:
- Java
tags:
- volatile
---
### Java关键字`volatile`

`volatile` 是 Java 中用来修饰变量的关键字，它的主要作用是告诉编译器和CPU，这个变量可能会被多个线程同时访问，需要确保线程之间的可见性和顺序性。当一个变量被声明为 `volatile`，在修改该变量的值时，会立即刷新到主内存中，同时在读取该变量时，会从主内存中获取最新的值，而不是使用线程的本地缓存。

### 问题：可见性和原子性

Java 中的多线程编程涉及到多个线程访问共享数据的情况。在没有同步机制保护的情况下，线程之间可能会产生数据不一致的问题。而 `volatile` 的作用正是为了解决可见性问题，它能够保证当一个线程修改了 `volatile` 变量的值时，其他线程能够立即看到这个修改。这样，就避免了多个线程对同一个变量进行操作时，读取到的是过期数据的问题。

然而，`volatile` 并不能解决原子性问题。原子性是指一个操作是不可分割的，要么全部执行成功，要么全部失败。在 `volatile` 变量上进行复合操作（比如自增）时，并不能保证原子性。多个线程同时对同一个 `volatile` 变量进行复合操作，可能会导致结果出现错误。

### 原因：线程的本地缓存和指令重排

Java 中的线程在执行时，为了提高执行效率，会将变量存储在线程的本地缓存中。这就导致了一个问题：一个线程修改了一个共享变量的值，但由于其他线程使用的是本地缓存，它们可能无法立即看到修改后的值，而是使用了过期的值。

此外，为了提高程序的执行效率，JVM 和CPU 可能会对指令进行重排。在不改变单线程执行结果的前提下，JVM 和 CPU 可能会对指令的执行顺序进行优化。而这种指令重排在多线程环境下可能会导致线程读取到不正确的数据。

因此，Java 使用 `volatile` 关键字来告诉编译器和 CPU，这个变量可能会被多个线程同时访问，需要避免指令重排，并在修改变量时立即刷新到主内存，以保证线程之间的可见性和顺序性。但需要注意的是，`volatile` 并不能保证复合操作的原子性，需要结合其他同步机制来解决原子性问题。